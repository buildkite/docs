<!--
 _____           ______                _______    _ _
(____ \         |  ___ \       _      (_______)  | (_)_
 _   \ \ ___    | |   | | ___ | |_     _____   _ | |_| |_
| |   | / _ \   | |   | |/ _ \|  _)   |  ___) / || | |  _)
| |__/ / |_| |  | |   | | |_| | |__   | |____( (_| | | |__
|_____/ \___/   |_|   |_|\___/ \___)  |_______)____|_|\___)

This file is auto-generated by scripts/agent_experiments2docs/agent_experiments2docs.rb.

To update this file:

1. Make changes to the relevant agent files in https://github.com/buildkite/agent
   For content not in that repo, edit it in scripts/agent_experiments2docs/agent_experiments2docs.rb
2. Run './scripts/update-agent-experiments.sh' from the docs repo root
-->

# Agent experiments

Buildkite frequently introduces new experimental features to the agent. Use the [`--experiment` flag](/docs/agent/v3/self-hosted/configure#experiment) to opt-in to them and test them out:

```
buildkite-agent start --experiment experiment1 --experiment experiment2
```

Or you can set them in your [agent configuration file](/docs/agent/v3/self-hosted/configure):

```
experiment="experiment1,experiment2"
```

If an experiment doesn't exist, no error will be raised.

> ðŸš§
> Please note that there is a likely chance that these experiments we will be removed or changed. Therefore, using them should be at your own risk, and without the expectation that these experiments will work in future.

## Available experiments

### Agent API

This exposes a local API for interacting with the agent process.
...with primitives that can be used to solve local concurrency problems (such as multiple agents handling some shared local resource).

The API is exposed using a Unix Domain Socket. The path to the socket is not available using a environment variable - rather, there is a single (configurable) path on the system.

> ðŸ› 
> To use this feature, set <code>experiment="agent-api"</code> in your <a href="/docs/agent/v3/self-hosted/configure#experiment">agent configuration</a>.

### Allow artifact path traversal

Uploaded artifacts include a relative path used by the artifact download tool to download the artifact to a suitable location relative to the destination path. In most circumstances the relative paths generated by `artifact upload` won't contain `..` components, and so will always be downloaded at or inside the destination path.

However, it is possible to upload artifacts using glob patterns containing one or more `..` components, which may be preserved in the artifact path. It is also possible for a user to call the Agent REST API directly in order to upload artifacts with arbitrary paths.

Leaving this experiment disabled prevents `..` components in artifact paths from traversing up from the destination path. Enabling this experiment permits the less-secure behaviour of allowing artifact paths containing `..` to traverse up the destination path.

For example, if an artifact was uploaded with the path `../../foo.txt`, then the command:

```shell
buildkite-agent artifact download '*.txt' .
```

has a different effect depending on this experiment:

- With `allow-artifact-path-traversal` disabled, `foo.txt` is downloaded to `./foo.txt`.
- With `allow-artifact-path-traversal` enabled, `foo.txt` is downloaded to `../../foo.txt`.

> ðŸ› 
> To use this feature, set <code>experiment="allow-artifact-path-traversal"</code> in your <a href="/docs/agent/v3/self-hosted/configure#experiment">agent configuration</a>.

### Descending spawn priority


> ðŸ› 
> To use this feature, set <code>experiment="descending-spawn-priority"</code> in your <a href="/docs/agent/v3/self-hosted/configure#experiment">agent configuration</a>.

### Interpolation prefers runtime env

When interpolating the pipeline level environment block, a pipeline level environment variable could take precedence over environment variables depending on the ordering. This may contravene Buildkite's [documentation](https://buildkite.com/docs/pipelines/environment-variables#environment-variable-precedence) that suggests the Job runtime environment takes precedence over that defined by combining environment variables defined in a pipeline.

We previously made this the default behaviour of the agent (as of v3.63.0) but have since reverted it.

> ðŸ› 
> To use this feature, set <code>experiment="interpolation-prefers-runtime-env"</code> in your <a href="/docs/agent/v3/self-hosted/configure#experiment">agent configuration</a>.

### Normalised upload paths

Artifacts found by `buildkite-agent artifact upload` will be uploaded using URI/Unix-style paths, even on Windows. This changes the URLs that artifacts uploaded from Windows agents are stored at, but to one which is URI-compatible.

Artifact names displayed in Buildkite's web UI, as well as in the API, are changed by this.

Take `buildkite-agent artifact upload coverage\report.xml` as an example:

- By default, and without this experiment, this file is uploaded to `s3://example/coverage\report.xml`.
- With this experiment enabled, it would be `s3://example/coverage/report.xml`.

**Status**: a major improvement for Windows compatibility, we'd like this to be the standard behaviour in 4.0. ðŸ‘ðŸ‘

> ðŸ› 
> To use this feature, set <code>experiment="normalised-upload-paths"</code> in your <a href="/docs/agent/v3/self-hosted/configure#experiment">agent configuration</a>.

### Override zero exit on cancel

If the job is cancelled, and the exit status of the process is 0, it is overridden to be 1 instead.

When cancelling a job, the agent signals the process, which typically causes it to exit with a
non-zero status code. On Windows this is not true - the process exits with code 0 instead, which
makes the job appear to be successful. (It successfully exited, no?) By overriding the status to 1,
a cancelled job should appear as a failure, regardless of the OS the agent is running on.

> ðŸ› 
> To use this feature, set <code>experiment="override-zero-exit-on-cancel"</code> in your <a href="/docs/agent/v3/self-hosted/configure#experiment">agent configuration</a>.

### Propagate agent config vars


> ðŸ› 
> To use this feature, set <code>experiment="propagate-agent-config-vars"</code> in your <a href="/docs/agent/v3/self-hosted/configure#experiment">agent configuration</a>.

### PTY raw

Set PTY to raw mode, to avoid mapping LF (\n) to CR,LF (\r\n) in job command output.
These extra newline characters are normally not noticed, but can make raw logs appear double-spaced
in some circumstances.

We run commands in a PTY mostly (entirely?) so that the program detects a PTY and behaves like it's
running in a terminal, using ANSI escapes to provide colours, progress meters etc. But we don't need
the PTY to modify the stream. (Or do we? That's why this is an experiment)

> ðŸ› 
> To use this feature, set <code>experiment="pty-raw"</code> in your <a href="/docs/agent/v3/self-hosted/configure#experiment">agent configuration</a>.

### Resolve commit after checkout

After repository checkout, resolve `BUILDKITE_COMMIT` to a commit hash. This makes `BUILDKITE_COMMIT` useful for builds triggered against non-commit-hash refs such as `HEAD`.

**Status**: broadly useful, we'd like this to be the standard behaviour in 4.0. ðŸ‘ðŸ‘

> ðŸ› 
> To use this feature, set <code>experiment="resolve-commit-after-checkout"</code> in your <a href="/docs/agent/v3/self-hosted/configure#experiment">agent configuration</a>.

## Promoted experiments

The following features started as experiments before being promoted to fully supported features. Therefore, these features are now a part of the Buildkite agent's default behavior, and there's no additional configuration required to use them.

### ANSI timestamps

Promoted in [v3.48.0](https://github.com/buildkite/agent/releases/tag/v3.48.0).
Learn more about this feature in [ANSI timestamps and disabling them](/docs/pipelines/configure/managing-log-output#ansi-timestamps-and-disabling-them).

### Avoid recursive trap

Promoted in [v3.66.0](https://github.com/buildkite/agent/releases/tag/v3.66.0).

### Flock file locks

Promoted in [v3.48.0](https://github.com/buildkite/agent/releases/tag/v3.48.0).
Learn more about this feature in [Flock file locks](/docs/agent/v3/cli/reference/lock#flock-file-locks).

### Git mirrors

Promoted in [v3.47.0](https://github.com/buildkite/agent/releases/tag/v3.47.0).
Learn more about this feature in [Git mirrors](/docs/agent/v3/self-hosted/configure/git-mirrors) and [Setting up Git mirrors](/docs/agent/v3/self-hosted/configure/git-mirrors#setting-up-git-mirrors).

### Inbuilt status page

Promoted in [v3.48.0](https://github.com/buildkite/agent/releases/tag/v3.48.0).

### Isolated plugin checkout

Promoted in [v3.67.0](https://github.com/buildkite/agent/releases/tag/v3.67.0).

### Job API

Promoted in [v3.64.0](https://github.com/buildkite/agent/releases/tag/v3.64.0).
Learn more about this feature in [Internal job API](/docs/apis/agent-api/internal-job).

### Kubernetes exec

Promoted in [v3.74.0](https://github.com/buildkite/agent/releases/tag/v3.74.0).

### Polyglot hooks

Promoted in [v3.85.0](https://github.com/buildkite/agent/releases/tag/v3.85.0).
Learn more about this feature in [Polyglot hooks](/docs/agent/v3/self-hosted/hooks#polyglot-hooks).

### Use zzglob

Promoted in [v3.104.0](https://github.com/buildkite/agent/releases/tag/v3.104.0).
Learn more about this feature in [Glob pattern syntax](/docs/pipelines/configure/glob-pattern-syntax).
