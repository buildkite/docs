# The Buildkite Agent

<!--alex ignore easy-->

The Buildkite agent is a small, reliable and cross-platform build runner that makes it easy to run automated builds on [your own self-hosted](/docs/agent/v3/self-hosted) or [Buildkite's hosted](/docs/agent/v3/buildkite-hosted) infrastructure. The agent's main responsibilities are polling buildkite.com for work, running a build's jobs, reporting back the status code and output log of the job, and uploading the job's artifacts.

This page contains reference information for Buildkite organization administrators that provides an overview on how Buildkite agents work, and how to set up and configuration them to work with your Buildkite organization.

If you're new to Buildkite Pipelines, run through the [Getting started with Pipelines](/docs/pipelines/getting-started) tutorial, which will initially set you up to run [Buildkite hosted agents](/docs/agent/v3/buildkite-hosted). From there, you can decide whether to continue using Buildkite hosted agents, or set yourself up to run [self-hosted agents](/docs/agent/v3/self-hosted).

## How it works

The agent works by polling Buildkite's agent API over HTTPS. There is no need to forward ports or provide incoming firewall access, and the agents can be run across any number of machines and networks.

The agent starts by registering itself with Buildkite, and once registered it's placed into your organization's agents pool. The agent periodically polls the Buildkite platform, looking for new work, waiting to accept an available job.

After accepting a build job the agent will execute the command, streaming back the build script's output and then posting the final exit status.

Whilst the job is running you can use the `buildkite-agent meta-data` command to set and get build-wide meta-data, and `buildkite-agent artifact` for fetching and retrieving binary build-wide artifacts. These two commands allow you to have completely isolated build jobs (similar to a 12 factor web application) but have access to shared state and data storage across any number of machines and networks.

### Job routing

By default, a pipeline's jobs run on the first available agent associated with the relevant [queues](/docs/agent/v3/queues) that the pipeline's [cluster](/docs/pipelines/security/clusters) is set to. Agents associated with a queue are ordered for selection by how recently these agents successfully completed a job. This takes advantage of warm caches to guarantee the fastest run time possible.

Learn more about how Buildkite routes jobs to queues in the [Queues overview](/docs/agent/v3/queues) page.

## Command line usage

The agent has a command line interface (CLI), with the following commands and built-in help.

<div class="highlight">
  <pre class="highlight shell"><code>$ buildkite-agent --help
Usage:

  buildkite-agent [command] [arguments...]

Available commands are:

  <a href="/docs/agent/v3/cli/reference/start">start</a>      Starts a Buildkite agent
  <a href="/docs/agent/v3/cli/reference/annotate">annotate</a>   Annotate the build page within the Buildkite UI with text from within a Buildkite job
  <a href="/docs/agent/v3/cli/reference/artifact">artifact</a>   Upload/download artifacts from Buildkite jobs
  <a href="/docs/agent/v3/cli/reference/env">env</a>        Process environment subcommands
  <a href="/docs/agent/v3/cli/reference/lock">lock</a>       Process lock subcommands
  <a href="/docs/agent/v3/cli/reference/meta-data">meta-data</a>  Get/set data from Buildkite jobs
  <a href="/docs/agent/v3/cli/reference/pipeline">pipeline</a>   Make changes to the pipeline of the currently running build
  <a href="/docs/agent/v3/cli/reference/bootstrap">bootstrap</a>  Run a Buildkite job locally
  <a href="/docs/agent/v3/cli/reference/step">step</a>       Retrieve and update the attributes of steps
  <a href="/docs/agent/v3/cli/reference/stop">stop</a>       Stop the agent
  <a href="/docs/agent/v3/cli/reference/redactor">redactor</a>   Redact sensitive information from logs
  <a href="/docs/agent/v3/cli/reference/tool">tool</a>       Utility commands, intended for users and operators of the agent to run directly on their machines, and not as part of a Buildkite job
  <a href="/docs/agent/v3/cli/reference/secret">secret</a>     Interact with Pipelines Secrets
  help       Shows a list of commands or help for one command

Use "buildkite-agent [command] --help" for more information about a command.
</code></pre>
</div>

## Customizing with hooks

The agent's behavior can be customized using hooks, which are shell scripts that exist on your build machines or in each pipeline's code repository. Hooks can be used to set up [secrets](/docs/pipelines/security/secrets/managing) as well as overriding default behavior. See the [hooks](/docs/agent/v3/hooks) documentation for full details.

## Signal handling

When a build job is canceled the agent will send the build job process a `SIGTERM` signal to allow it to gracefully exit.

If the process does not exit within the 10s grace period it will be forcefully terminated with a `SIGKILL` signal. If you require a longer grace period, it can be customized using the [cancel-grace-period](/docs/agent/v3/self-hosted/configure#configuration-settings) agent configuration option.

The agent also accepts the following two signals directly:

- `SIGTERM` - Instructs the agent to gracefully disconnect, after completing any job that it may be running.
- `SIGQUIT` - Instructs the agent to forcefully disconnect, canceling any job that it may be running.

## Exit codes

The agent reports its activity to Buildkite using exit codes. The most common exit codes and their descriptions can be found in the table below.

Exit code           | Description
------------------- | -------------------------------------------------------------------
0                   | The job exited with a status of 0 (success)
1                   | The job exited with a status of 1 (most common error status)
94                  | The checkout timed out waiting for a Git mirrors lock
128 + signal number | The job was terminated by a signal (see note below)
255                 | The agent was gracefully terminated
-1                  | Buildkite lost contact with the agent or it stopped reporting to us

> ðŸ“˜ Jobs terminated by signals
> When a job is terminated by a signal, the exit code will be set to 128 + the signal number. For more information about how shells manage commands terminated by signals, see the Wiki page on <a href="https://en.wikipedia.org/wiki/Exit_status#Shell_and_scripts">Exit Signals</a>.

Exit codes for common signals:

Exit code | Signal | Name    | Description
--------- | ------ | ------- | --------------------------------------------
130       | 2      | SIGINT  | Terminal interrupt signal
137       | 9      | SIGKILL | Kill (cannot be caught or ignored)
139       | 11     | SIGSEGV | Segmentation fault; Invalid memory reference
141       | 13     | SIGPIPE | Write on a pipe with no one to read it
143       | 15     | SIGTERM | Termination signal (graceful)

## Troubleshooting

One issue you sometimes need to troubleshoot is when Buildkite loses contact with an agent, resulting in a `-1` exit code. After registering with the Buildkite API, an agent regularly sends heartbeat updates to indicate that it is operational. If the Buildkite API does not receive any heartbeat requests from an agent for 3 consecutive minutes, that agent is marked as lost within the next 60 seconds, and will not be assigned any further jobs.

Various factors can cause an agent to fail to send heartbeat updates. Common reasons include networking issues and resource constraints, such as CPU, memory, or I/O limitations on the infrastructure hosting the agent.

In such cases, it's essential to check the agent logs and examine metrics related to networking, CPU, memory, and I/O to help identify the cause of the failed heartbeat updates.

If the agents run on the Elastic CI Stack for AWS with spot instances, the abrupt termination of spot instances can also result in marking agents as lost. To investigate this issue, you can use the [log collector script](https://github.com/buildkite/elastic-ci-stack-for-aws?tab=readme-ov-file#collect-logs-via-script) script to gather all relevant logs and metrics from the Elastic CI Stack for AWS.

### Timeouts

Occasionally, a job may time out if it exceeds the maximum allowed [command step timeout](/docs/pipelines/configure/build-timeouts). Depending on the `cancel-grace-period` set on the agent, the job may not complete gracefully, resulting in an unexpected exit code (`-1`).
