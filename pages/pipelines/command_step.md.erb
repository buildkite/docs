# Command Step

A command step runs one or more shell commands on one or more agents.

{:toc}

Each command step can run either a shell command like `npm test`, or an executable file or script like `build.sh`.

A command step can be defined in your pipeline settings, or in your [pipeline.yml](/docs/pipelines/defining-steps) file.

```yml
steps:
  - command: "tests.sh"
```
{: codeblock-file="pipeline.yml"}

When running multiple commands, either defined in a single line (`npm install && tests.sh`) or defined in a list, any failure will prevent subsequent commands from running, and will mark the command step as failed.

## Command step attributes

_Required attributes:_

<table data-attributes data-attributes-required>
  <tr>
    <td><code>command</code></td>
    <td>
      The shell command/s to run during this step. This can be a single line of commands, or a list of commands that must all pass. Also available as the alias <code>commands</code>.<br>
      <em>Example:</em> <code>"build.sh"</code><br>
      <em>Example:</em><br><code>- "npm install"</code><br><code>- "tests.sh"</code>
    </td>
  </tr>
</table>

```yml
steps:
  - commands:
    - "npm install && npm test"
    - "moretests.sh"
    - "build.sh"
```
{: codeblock-file="pipeline.yml"}

>ðŸ“˜ Pipelines without command steps
> Although the <code>command</code> attribute is required for a command step, some <a href="/docs/plugins/using#adding-a-plugin-to-your-pipeline">plugins</a> work without a command step, so it isn't strictly necessary for your pipeline to have an explicit command step.

_Optional attributes:_

<table data-attributes>
  <tr>
    <td><code>agents</code></td>
    <td>
      A map of <a href="/docs/agent/v3/cli-start#setting-tags">agent tag</a> keys to values to <a href="/docs/agent/v3/cli-start#agent-targeting">target specific agents</a> for this step. <br>
      <em>Example:</em> <code>npm: "true"</code>
    </td>
  </tr>
  <tr>
    <td><code>allow_dependency_failure</code></td>
    <td>
      Whether to continue to run this step if any of the steps named in the <code>depends_on</code> attribute fail.<br>
      <em>Default:</em> <code>false</code>
    </td>
  </tr>
  <tr>
    <td><code>artifact_paths</code></td>
    <td>
      The <a href="/docs/agent/v3/cli-artifact#uploading-artifacts">glob path</a> or paths of <a href="/docs/agent/v3/cli-artifact">artifacts</a> to upload from this step. This can be a single line of paths separated by semicolons, or a list.<br>
      <em>Example:</em> <code>"logs/**/*;coverage/**/*"</code><br>
      <em>Example:</em><br><code>- "logs/**/*"</code><br><code>- "coverage/**/*"</code>
    </td>
  </tr>
  <tr>
    <td><code>branches</code></td>
    <td>
      The <a href="/docs/pipelines/branch-configuration#branch-pattern-examples">branch pattern</a> defining which branches will include this step in their builds.<br>
      <em>Example:</em> <code>"main stable/*"</code>
    </td>
  </tr>
  <tr>
    <td><code>cancel_on_build_failing</code></td>
    <td>
      Setting this attribute to <code>true</code> cancels the job as soon as the build is marked as <a href="/docs/pipelines/defining-steps#build-states">failing</a>.<br>
      <em>Default:</em> <code>"false"</code>
    </td>
  </tr>
  <tr>
    <td><code>concurrency</code></td>
    <td>
      The <a href="/docs/pipelines/controlling-concurrency#concurrency-limits">maximum number of jobs</a> created from this step that are allowed to run at the same time. If you use this attribute, you must also define a label for it with the <code>concurrency_group</code> attribute.<br>
      <em>Example:</em> <code>3</code>
    </td>
  </tr>
  <tr>
    <td><code>concurrency_group</code></td>
    <td>
      A unique name for the concurrency group that you are creating. If you use this attribute, you must also define the <code>concurrency</code> attribute.<br>
      <em>Example:</em> <code>"my-app/deploy"</code>
    </td>
  </tr>
  <tr>
    <td><code>depends_on</code></td>
    <td>
      A list of step keys that this step depends on. This step will only run after the named steps have completed. See <a href="/docs/pipelines/dependencies">managing step dependencies</a> for more information.<br>
      <em>Example:</em> <code>"test-suite"</code>
    </td>
  </tr>
  <tr>
    <td><code>env</code></td>
    <td>
      A map of <a href="/docs/pipelines/environment-variables">environment variables</a> for this step.<br>
      <em>Example:</em> <code>RAILS_ENV: "test"</code>
    </td>
  </tr>
  <tr>
    <td><code>if</code></td>
    <td>
      A boolean expression that omits the step when false. See <a href="/docs/pipelines/conditionals">Using conditionals</a> for supported expressions.<br>
      <em>Example:</em> <code>build.message != "skip me"</code>
    </td>
  </tr>
  <tr>
    <td><code>key</code></td>
    <td>
      A unique string to identify the step. The value is available in the <code>BUILDKITE_STEP_KEY</code> <a href="/docs/pipelines/environment-variables">environment variable</a>.<br>
      Keys can not have the same pattern as a UUID (<code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code>).<br>
      <em>Example:</em> <code>"linter"</code>
      <em>Alias:</em> <code>identifier</code>
    </td>
  </tr>
  <tr id="label">
    <td><code>label</code></td>
    <td>
      The label that will be displayed in the pipeline visualisation in Buildkite. Supports emoji.<br>
      <em>Example:</em> <code>"\:hammer\: Tests" will be rendered as "ðŸ”¨ Tests"</code><br></code><br>
    </td>
  </tr>
  <tr>
    <td><code>matrix</code></td>
    <td>
      Either an array of values to be used in the matrix expansion, or a single <code>setup</code> key, and an optional <code>adjustments</code> key.<br>
      <code>steps:<br>
- label: "{{matrix}} build"<br>
&nbsp;&nbsp;command: "echo '.buildkite/steps/build-binary.sh {{matrix}}'"<br>
&nbsp;&nbsp;&nbsp;&nbsp;matrix:<br>
&nbsp;&nbsp;&nbsp;&nbsp;- "macOS"<br>
&nbsp;&nbsp;&nbsp;&nbsp;- "Linux"<code>
    </td>
  </tr>
  <tr>
    <td><code>parallelism</code></td>
    <td>
      The number of <a href="/docs/tutorials/parallel-builds#parallel-jobs">parallel jobs</a> that will be created based on this step. <br>
      <em>Example:</em> <code>3</code>
    </td>
  </tr>
  <tr>
    <td><code>plugins</code></td>
    <td>
      An array of <a href="/docs/plugins">plugins</a> for this step.<br>
      <em>Example:</em><br>
      <code>- docker-compose#v1.0.0:<br>
&nbsp;&nbsp;&nbsp;&nbsp;run: app</code>
    </td>
  </tr>
  <tr>
    <td><code>priority</code></td>
    <td>
      Adjust the <a href="/docs/pipelines/managing-priorities">priority</a> for a specific job, as a positive or negative integer.<br>
      <em>Example:</em><br>
      <code>- command: "will-run-first.sh"<br>&nbsp;&nbsp;priority: 1</code>
    </td>
  </tr>
  <tr>
    <td><code>retry</code></td>
    <td>
      The conditions for retrying this step.<br>
      Available types: <code>automatic</code>, <code>manual</code>
    </td>
  </tr>
  <tr>
    <td><code>skip</code></td>
    <td>
      Whether to skip this step or not. Passing a string provides a reason for skipping this command. Passing an empty string is equivalent to <code>false</code>.
      Note: Skipped steps will be hidden in the pipeline view by default, but can be made visible by toggling the 'Skipped jobs' icon.<br>
      <em>Example:</em> <code>true</code><br>
      <em>Example:</em> <code>false</code><br>
      <em>Example:</em> <code>"My reason"</code>
    </td>
  </tr>
  <tr>
    <td><code>soft_fail</code></td>
    <td>
      Allow specified non-zero exit statuses not to fail the build.
      Can be either an array of allowed soft failure exit statuses or <code>true</code> to make all exit statuses soft-fail.<br>
      <em>Example:</em> <code>true</code><br>
      <em>Example:</em><br>
      <code>- exit_status: 1</code><br>
    </td>
  </tr>
  <tr id="timeout_in_minutes">
    <td><code>timeout_in_minutes</code></td>
    <td>
      The maximum number of minutes a job created from this step is allowed to run. If the job exceeds this time limit, or if it finishes with a non-zero exit status, the job is automatically canceled and the build fails. Jobs that time out with an exit status of 0 are marked as "passed".<br> Note that command steps on the Buildkite <a href="https://buildkite.com/pricing">Free plan</a> have a maximum job timeout of 240 minutes.<br> You can also set <a href="/docs/pipelines/command-step#command-step-attributes-build-timeouts">default and maximum timeouts</a> in the Buildkite UI.
      <em>Example:</em> <code>60</code>
    </td>
  </tr>
</table>

### Build timeouts

Timeouts for jobs can be specified as [command steps attributes](/docs/pipelines/command-step#timeout_in_minutes), but it's possible to avoid having to set them manually every time.

To prevent jobs from consuming too many job minutes or running forever, you can specify default as well as maximum timeouts from your organization's [Pipeline Settings page](https://buildkite.com/organizations/~/pipeline-settings), or on a pipeline's Builds settings page.

<%= image "default-timeout.png", width: 1724/2, height: 736/2, alt: "Set default and maximum timeout period for your jobs" %>

Specific timeouts take precedence over more general ones â€” a step level timeout takes precedence over a pipeline timeout, which in turn takes precedence over an organization default.

Maximum timeouts are applied to any command step without a timeout or with a timeout greater than the maximum timeout.

Maximums are always enforced, when supplied â€” the smallest value will be used.

## Retry attributes

_At least one of the following attributes is required:_

<table>
  <tr>
    <td><code><a href="/docs/pipelines/command-step#retry-attributes-automatic-retry-attributes">automatic</a></code></td>
    <td>
      Whether to allow a job to retry automatically. This field accepts a boolean value, individual retry conditions, or a list of multiple different retry conditions.<br> If set to <code>true</code>, the retry conditions are set to the default value.<br>
      <em>Default value:</em><br>
      <code>exit_status: "*"</code><br>
      <code>limit: 2</code><br>
      <em>Example:</em> <code>true</code>
    </td>
  </tr>
  <tr>
    <td><code><a href="/docs/pipelines/command-step#retry-attributes-manual-retry-attributes">manual</a></code></td>
    <td>
      Whether to allow a job to be retried manually. This field accepts a boolean value, or a single retry condition.<br>
      <em>Default value:</em> <code>true</code><br>
      <em>Example:</em> <code>false</code>
    </td>
  </tr>
</table>

```yml
steps:
  - label: "Tests"
    command: "tests.sh"
    retry:
      automatic: true

  - wait

  - label: "Deploy"
    command: "deploy.sh"
    retry:
      manual: false
```
{: codeblock-file="pipeline.yml"}

If you retry a job, the information about the failed job(s) remains, and a new job is created. The history of retried jobs is preserved and immutable. The number of possible retries is available as an [environment variable `limit`](/docs/pipelines/command-step#retry-attributes-automatic-retry-attributes) on the job.

<%= image "retry-time-date.png", width: 2456/2, height: 1076/2, alt: "You can view how and when a job was retried" %>

You can also see when a job has been retried and whether it was retried automatically or by a user. Such jobs will hidden - you can expand and view all the hidden retried jobs.

<%= image "hidden-jobs.png", width: 1400, height: 330, alt: "Retry history is preserved and can be viewed" %>

In the Buildkite UI, there is a [Job Retries Report section](https://buildkite.com/organizations/~/reports/job-retries) where you can view a graphic report on jobs retried manually or automatically within the last 30 days. This can help you understand flakiness and instability across all of your pipelines.

<%= image "job-retries-report.png", width: 2792/2, height: 1400/2, alt: "Information on manual and automatic job retries over the last 24 hours to 30 days " %>

Conditions on retries can be specified. For example, it's possible to set steps to be retried automatically if they exit with particular exit codes, or prevent retries on important steps like deployments. The following example shows different retry configurations:

```yml
  - label: "Tests"
    command: "tests.sh"
    retry:
      automatic:
        - exit_status: 5
          limit: 2
        - exit_status: "*"
          limit: 4
  - wait
  - label: "Deploy"
    command: "deploy.sh"
    branches: "main"
    retry:
      manual: false
      reason: "Deploys shouldn't be retried"
```
{: codeblock-file="pipeline.yml"}

### Automatic retry attributes

_Optional Attributes_

<table>
  <tr>
    <td><code>exit_status</code></td>
    <td>
      The exit status number that will cause this job to retry ('*' does not include 0) <br>
      <em>Example:</em> <code>"*"</code><br>
      <em>Example:</em> <code>2</code>
    </td>
  </tr>
  <tr>
    <td><code>limit</code></td>
    <td>
      The number of times this job can be retried. The maximum value this can be set to is 10.<br>
      <em>Example:</em> <code>3</code>
    </td>
  </tr>
</table>

>ðŸ“˜ -1 exit status
> A job will fail with an exit status of -1 if communication with the agent has been lost (for example, the agent has been forcefully terminated, or the agent machine was shut down without allowing the agent to disconnect). See the section on <a href="/docs/agent/v3#exit-codes">Exit Codes</a> for information on other exit codes.

```yml
steps:
  - label: "Tests"
    command: "tests.sh"
    retry:
      automatic:
        - exit_status: -1  # Agent was lost
          limit: 2
        - exit_status: 255 # Forced agent shutdown
          limit: 2
```
{: codeblock-file="pipeline.yml"}

### Manual retry attributes

_Optional Attributes_

<table>
  <tr>
    <td><code>allowed</code></td>
    <td>
      A boolean value that defines whether or not this job can be retried manually.<br>
      <em>Default value:</em> <code>true</code><br>
      <em>Example:</em> <code>false</code>
    </td>
  </tr>
  <tr>
    <td><code>permit_on_passed</code></td>
    <td>
      A boolean value that defines whether or not this job can be retried after it has passed.<br>
      <em>Example:</em> <code>false</code>
    </td>
  </tr>
  <tr>
    <td><code>reason</code></td>
    <td>
      A string that will be displayed in a tooltip on the Retry button in Buildkite. This will only be displayed if the <code>allowed</code> attribute is set to false.<br>
      <em>Example:</em> <code>"No retries allowed on deploy steps"</code>
    </td>
  </tr>
</table>

```yml
steps:
  - label: "Tests"
    command: "tests.sh"
    retry:
      manual:
        permit_on_passed: true

  - wait

  - label: "Deploy"
    command: "deploy.sh"
    retry:
      manual:
        allowed: false
        reason: "Sorry, you can't retry a deployment"
```
{: codeblock-file="pipeline.yml"}

## Soft fail attributes

_Optional Attributes_

<table>
  <tr>
    <td><code>exit_status</code></td>
    <td>
      Allow specified non-zero exit statuses not to fail the build.
      <br>
      <em>Example:</em> <code>"*"</code><br>
      <em>Example:</em> <code>1</code>
    </td>
  </tr>
</table>

```yml
steps:
  - label: "Everyone struggles sometimes"
    command: "tests.sh"
    soft_fail:
      - exit_status: 1
```
{: codeblock-file="pipeline.yml"}


## Matrix attributes

<table>
  <tr>
    <td><code>setup</code></td>
    <td>
      A list of dimensions, each containing an array of elements. The job matrix is built by combining all values of each dimension, with the other elements of each dimension.
    </td>
  </tr>
  <tr>
    <td><code>adjustments</code></td>
    <td>
      A array of <code>with</code> keys, each mapping an element to each dimension listed in the `array.setup`, as well as the attribute to modify for that combination.<br>
      Currently, only <code>soft_fail</code> and <code>skip</code> can be modified.
    </td>
  </tr>
</table>

```yaml
steps:
- label: "ðŸ’¥ Matrix build with adjustments"
  command: "echo {{matrix.os}} {{matrix.arch}} {{matrix.test}}"
  matrix:
    setup:
      arch:
        - "amd64"
        - "arm64"
      os:
        - "windows"
        - "linux"
      test:
        - "A"
        - "B"
    adjustments:
      - with:
          os: "windows"
          arch: "arm64"
          test: "B"
        soft_fail: true
      - with:
          os: "linux"
          arch: "arm64"
          test: "B"
        skip: true
```
{: codeblock-file="pipeline.yml"}

## Fail fast

To automatically cancel remaining jobs as soon the first job fails (except jobs that you've marked as `soft_fail`):

1. Make sure that _Publish failed state early_ is checked in your _Pipeline Repository_ settings
2. Mark jobs that you want to cancel immediately with `cancel_on_build_failing: true`

Next time a job in your build fails, those jobs will be automatically cancelled.

<!--

TODO:
To set `cancel_on_build_failing: true` for all jobs in a Build:


 -->

## Example


```yml
steps:
  - label: "\:hammer\: Tests"
    commands:
      - "npm install"
      - "npm run tests"
    branches: "main"
    env:
      NODE_ENV: "test"
    agents:
      npm: "true"
      queue: "tests"
    artifact_paths:
      - "logs/**/*"
      - "coverage/**/*"
    parallelism: 5
    timeout_in_minutes: 3
    retry:
      automatic:
        - exit_status: -1
          limit: 2
        - exit_status: 143
          limit: 2
        - exit_status: 255
          limit: 2

  - label: "Visual diff"
    commands:
      - "npm install"
      - "npm run visual-diff"
    retry:
      automatic:
        limit: 3

  - label: "Skipped job"
    command: "broken.sh"
    skip: "Currently broken and needs to be fixed"

  - wait

  - label: "\:shipit\: Deploy"
    command: "deploy.sh"
    branches: "main"
    concurrency: 1
    concurrency_group: "my-app/deploy"
    retry:
      manual:
        allowed: false
        reason: "Sorry, you can't retry a deployment"

  - wait

  - label: "Smoke test"
    command: "smoke-test.sh"
    soft_fail:
      - exit_status: 1
```
{: codeblock-file="pipeline.yml"}
