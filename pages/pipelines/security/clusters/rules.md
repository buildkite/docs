# Rules overview

_Rules_ is a Buildkite feature that can do the following:

<%= render_markdown partial: 'pipelines/security/clusters/rules_summary' %>

> ðŸ“˜
> The _rules_ feature is currently in development, and is enabled on an opt-in basis for early access. To enable rules for your organization, please contact Buildkite's Support team at support@buildkite.com.

## Rule types

Buildkite Pipelines supports two types of rules that allow one pipeline build to:

- [Trigger another pipeline build](#rule-types-pipeline-dot-trigger-build-dot-pipeline).
- [Read the artifacts generated by another pipeline build](#rule-types-pipeline-dot-artifacts-read-dot-pipeline).

### pipeline.trigger_build.pipeline

This rule type allows one pipeline to trigger another, where:

- Both pipelines are in the same or different [clusters](/docs/pipelines/security/clusters).
- One pipeline is public and another is private.

> ðŸ“˜
> This rule type overrides the usual [trigger step permissions checks](/docs/pipelines/configure/step-types/trigger-step#permissions) on users and teams.

**Rule Document** format:

```json
{
  "rule": "pipeline.trigger_build.pipeline",
  "value": {
    "source_pipeline": "pipeline-uuid-or-slug",
    "target_pipeline": "pipeline-uuid-or-slug",
    "conditions": [
      "source.build.branch == 'main'",
      "source.build.commit == target.trigger.commit"
    ]
  }
}
```

where:

- `source_pipeline` is the UUID or slug of the pipeline that's allowed to trigger another pipeline.
- `target_pipeline` is the UUID or slug of the pipeline that can be triggered by the `source_pipeline`'s pipeline.
- `conditions` is an optional array of [conditionals](/docs/pipelines/configure/conditionals) that must be met to allow the `source_pipeline`'s pipeline to trigger the `target_pipeline`'s pipeline. Learn more about this in the following [Conditions](#conditions-trigger) section.

<a id="conditions-trigger"></a>

#### Conditions

The optional `conditions` field allows you to specify an array of [conditionals](/docs/pipelines/configure/conditionals) that must be met for the source pipeline (`source_pipeline`) to trigger the target pipeline (`target_pipeline`). In the example above, the rule would only allow triggering if the source pipeline's build branch is `main` and the commit of the source pipeline's build matches that of the target pipeline's trigger build. If no conditions are specified, triggering is allowed in all cases between the source and target pipelines. If _any_ of the conditions _are not_ met, triggering is not allowed, even if the default permissions would have allowed triggering. The conditions are evaluated using the [Buildkite conditionals syntax](/docs/pipelines/configure/conditionals#variable-and-syntax-reference).

In the `pipeline.trigger_build.pipeline` rule the available variables for conditions are:

<table>
<thead>
  <tr>
    <th style="width:25%">Variable</th>
    <th style="width:15%">Type</th>
    <th style="width:60%">Description</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td><code>source.build.*</code></td>
    <td><code>Build</code></td>
    <td>
      <p>The triggering build in the source pipeline (contains the trigger step). This includes all the variables available for a <a href="/docs/pipelines/configure/conditionals#variable-and-syntax-reference-variables">build</a>.</p>
      <p>Example variables available:</p>
      <ul>
        <li><code>source.build.branch</code> - the branch of the source pipeline that the trigger step is targeting.</li>
        <li><code>source.build.commit</code> - the commit of the source pipeline that the trigger step is targeting.</li>
        <li><code>source.build.message</code> - the commit message of the source pipeline that the trigger step is targeting.</li>
      </ul>
    </td>
  </tr>
  <tr>
    <td><code>target.trigger.branch</code></td>
    <td><code>String</code></td>
    <td>The branch of the target pipeline that the trigger step is targeting.</td>
  </tr>
  <tr>
    <td><code>target.trigger.commit</code></td>
    <td><code>String</code></td>
    <td>The commit of the target pipeline that the trigger step is targeting.</td>
  </tr>
  <tr>
    <td><code>target.trigger.message</code></td>
    <td><code>String</code></td>
    <td>The commit message of the target pipeline that the trigger step is targeting.</td>
  </tr>
</tbody>
</table>

> ðŸ“˜
> Conditions are shown in error messages when access is denied.

Learn more about creating rules in [Manage rules](/docs/pipelines/security/clusters/rules/manage).

#### Example use case: cross-cluster pipeline triggering

Clusters may be used to separate the environments necessary for building and deploying an application. For example, a continuous integration (CI) pipeline has been set up in cluster A and likewise, a continuous deployment (CD) pipeline in cluster B. Ordinarily, pipelines in separate clusters are not able to trigger builds between each other due to the strict isolation of clusters.

However, a `pipeline.trigger_build.pipeline` rule would allow a trigger step in the CI pipeline of cluster A to target the CD pipeline in cluster B. Such rules would allow deployment to be triggered upon a successful CI build, while still maintaining the separation between the CI and CD agents in their respective clusters.

### pipeline.artifacts_read.pipeline

This rule type allows one pipeline to access (that is, with read-only permissions) the artifacts built by another, where:

- Both pipelines are in the same or different [clusters](/docs/pipelines/security/clusters).
- One pipeline is public and another is private.

**Rule Document** format:

```json
{
  "rule": "pipeline.artifacts_read.pipeline",
  "value": {
    "source_pipeline": "pipeline-uuid-or-slug",
    "target_pipeline": "pipeline-uuid-or-slug",
    "conditions": [
      "source.build.branch == target.build.branch",
    ]
  }
}
```

where:

- `source_pipeline` is the UUID or slug of the pipeline that's allowed to access the artifacts from another pipeline.
- `target_pipeline` is the UUID or slug of the pipeline whose artifacts can be accessed by jobs in the `source_pipeline` pipeline.
- `conditions` is an optional array of [conditionals](/docs/pipelines/configure/conditionals) that must be met to allow the jobs of the `source_pipeline`'s pipeline to access the artifacts of the `target_pipeline`'s pipeline. Learn more about this in the following [Conditions](#conditions-artifacts) section.

<a id="conditions-artifacts"></a>

#### Conditions

The optional `conditions` field allows you to specify an array of [conditionals](/docs/pipelines/configure/conditionals) that must be met for jobs of the source pipeline (`source_pipeline`) to access artifacts built by the target pipeline (`target_pipeline`). In the example above, the rule would only allow artifact access if the source pipeline's build branch matches the target pipeline's build branch. If no conditions are specified, artifact access is allowed in all cases between the source and target pipelines. If _any_ of the conditions _are not_ met, artifact access is not allowed, even if the default permissions would have allowed triggering. The conditions are evaluated using the [Buildkite conditionals syntax](/docs/pipelines/configure/conditionals#variable-and-syntax-reference).

In the `pipeline.read_artifacts.pipeline` rule the available variables for conditions are:

<table>
<thead>
  <tr>
    <th style="width:25%">Variable</th>
    <th style="width:15%">Type</th>
    <th style="width:60%">Description</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td><code>source.build.*</code></td>
    <td><code>Build</code></td>
    <td>
      <p>The build in the source pipeline that is accessing the artifacts. This includes all the variables available for a <a href="/docs/pipelines/configure/conditionals#variable-and-syntax-reference-variables">build</a>.</p>
      <p>Example variables available:</p>
      <ul>
        <li><code>source.build.branch</code> - the branch of the source pipeline that is accessing the artifacts.</li>
        <li><code>source.build.commit</code> - the commit of the source pipeline that is accessing the artifacts.</li>
        <li><code>source.build.message</code> - the commit message of the source pipeline that is accessing the artifacts.</li>
      </ul>
    </td>
  </tr>
  <tr>
    <td><code>target.build.*</code></td>
    <td><code>Build</code></td>
    <td>
      <p>The build in the target pipeline that the artifacts are being accessed from. This includes all the variables available for a <a href="/docs/pipelines/configure/conditionals#variable-and-syntax-reference-variables">build</a>.</p>
      <p>Example variables available:</p>
      <ul>
        <li><code>target.build.branch</code> - the branch of the target pipeline that the artifacts are being accessed from.</li>
        <li><code>target.build.commit</code> - the commit of the target pipeline that the artifacts are being accessed from.</li>
        <li><code>target.build.message</code> - the commit message of the target pipeline that the artifacts are being accessed from.</li>
      </ul>
    </td>
  </tr>
  <tr>
    <td><code>source.request.query</code></td>
    <td><code>String</code></td>
    <td>The query used to search for artifacts in the target build. See <a href="/docs/agent/cli/reference/artifact#searching-artifacts">Searching artifacts</a> for more information on the query syntax.</td>
  </tr>
</tbody>
</table>

> ðŸ“˜
> Conditions are shown in error messages when access is denied.

Learn more about creating rules in [Manage rules](/docs/pipelines/security/clusters/rules/manage).

#### Example use case: sharing assets between clusters

Artifacts are not accessible between pipelines across different clusters. For example, a deployment pipeline in cluster B cannot ordinarily access artifacts uploaded by a CI pipeline in cluster A.

However, a `pipeline.artifacts_read.pipeline` rule can be used to override this restriction. For example, assets uploaded as artifacts by the CI pipeline would now be accessible to the deployment pipeline via the `buildkite-agent artifact download --build xxx` command.
