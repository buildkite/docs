#!/usr/bin/env bash

set -euo pipefail

# This picks the agent version to generate docs for.
# It should be a Git tag or commit hash.
AGENT_VERSION="0d2e270"

# Note that go install names the binary "agent", when it is normally
# "buildkite-agent". Rather than renaming, I'm leaving it, so that we avoid
# accidentally calling an existing buildkite-agent.
AGENT="$(go env GOPATH)/bin/agent"

echo "Installing buildkite-agent ${AGENT_VERSION} to ${AGENT}"

go install "github.com/buildkite/agent/v3@${AGENT_VERSION}"

echo "Installing cli2md"
go install -buildvcs=false ./scripts/cli2md
CLI2MD="$(go env GOPATH)/bin/cli2md"

commands=(
  "annotate"
  "annotation remove"
  "artifact download"
  "artifact shasum"
  "artifact upload"
  "artifact search"
  "bootstrap"
  "build cancel"
  "env dump"
  "env set"
  "env get"
  "env unset"
  "lock acquire"
  "lock do"
  "lock done"
  "lock get"
  "lock release"
  "meta-data exists"
  "meta-data get"
  "meta-data keys"
  "meta-data set"
  "oidc request-token"
  "pause"
  "pipeline upload"
  "redactor add"
  "resume"
  "secret get"
  "start"
  "step get"
  "step update"
  "step cancel"
  "stop"
  "tool keygen"
  "tool sign"
)

base_dir="$(git rev-parse --show-toplevel)"

for command in "${commands[@]}"; do
  file="${base_dir}/pages/agent/v3/help/_${command//[- ]/_}.md"
  if [[ ! -f "${file}" ]]; then
    echo "File ${file} doesn't exist"
    exit 1
  fi

  echo "Updating docs for buildkite-agent ${command}"

  cat << 'EOF' >"${file}"
<!--

 _____           ______                _______    _ _
(____ \         |  ___ \       _      (_______)  | (_)_
 _   \ \ ___    | |   | | ___ | |_     _____   _ | |_| |_
| |   | / _ \   | |   | |/ _ \|  _)   |  ___) / || | |  _)
| |__/ / |_| |  | |   | | |_| | |__   | |____( (_| | | |__
|_____/ \___/   |_|   |_|\___/ \___)  |_______)____|_|\___)

This file is auto-generated by scripts/update-agent-help.sh.

Instead of directly changing this file, you must:

1. Update the agent CLI help content in https://github.com/buildkite/agent (not in this repo)
2. Update AGENT_VERSION at the top of scripts/update-agent-help.sh (in your docs repo)
   to the new agent version tag or commit hash
3. From the root of your docs repo, run ./scripts/update-agent-help.sh

-->

EOF

  # shellcheck disable=SC2086
  "${AGENT}" ${command} --help | "${CLI2MD}" >>"$file"
done
