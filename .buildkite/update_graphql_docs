#!/bin/bash
set -euo pipefail

echo "+++ Configure git"
git config user.email $GIT_EMAIL
git config user.name $GIT_NAME

# echo "+++ Download GraphQL schema"
# buildkite-agent artifact download "schema.json" "docs/data/graphql_data_schema.json" --build $BUILDKITE_TRIGGERED_FROM_BUILD_ID

# if [[ -z "$(git status --porcelain)" ]]; then
#   echo "No changes to commit"
#   exit 0
# fi

echo "+++ Generate GraphQL docs"
./scripts/generate-graphql-api-content.sh

echo "+++ Check for changes"
# BRANCH=buildkite-docs-bot/graphql/$(git rev-parse --short :data/graphql_data_schema.json)
BRANCH=graphql-schema-update-$(date +%s)

echo "--- Commit and push changes"
git checkout -b $BRANCH
git add .
git commit -m "Update GraphQL docs" --allow-empty # fixme: this is temporary, until we have a schema change
# git commit -m "Update GraphQL docs"

echo "+++ Push changes"
git push -u origin $BRANCH

echo "+++ Create pull request"
gh pr create \
  --title "Update GraphQL schema" \
  --body "This is automated PR for generating docs based on the latest GraphQL schema."

